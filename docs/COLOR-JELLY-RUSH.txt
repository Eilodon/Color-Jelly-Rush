

# ğŸ›ï¸ MASTER PLAN V3.3: EIDOLON PLATFORM REVOLUTION (FINAL)

**Má»¤C TIÃŠU Tá»I THÆ¯á»¢NG:**
Biáº¿n `packages/engine` thÃ nh má»™t **"MÃ¡y in game" (Game Printer)** Ä‘a dá»¥ng.
Engine khÃ´ng Ä‘Æ°á»£c biáº¿t `Jelly` lÃ  gÃ¬. `Jelly` chá»‰ lÃ  dá»¯ liá»‡u Ä‘Æ°á»£c náº¡p vÃ o.

---

## PHáº¦N 1: Cáº¤U TRÃšC Váº¬T LÃ & QUY HOáº CH (PHYSICAL ARCHITECTURE)

ChÃºng ta tÃ¡i cáº¥u trÃºc Monorepo Ä‘á»ƒ táº¡o ra má»™t **Shared Kernel** (Háº¡t nhÃ¢n dÃ¹ng chung) cho cáº£ Client, Server vÃ  Tools.

### 1. Cáº¥u TrÃºc ThÆ° Má»¥c (Directory Map)

```text
packages/engine/src/
â”œâ”€â”€ kernel/                 (ğŸ§  THE BRAIN - 100% AGNOSTIC & SHARED)
â”‚   â”œâ”€â”€ memory/
â”‚   â”‚   â”œâ”€â”€ MemoryBlock.ts  (ArrayBuffer liá»n máº¡ch, Zero-GC, Resizable)
â”‚   â”‚   â””â”€â”€ Allocator.ts    (Quáº£n lÃ½ Generation ID, chá»‘ng lá»—i ABA)
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ Registry.ts     (Map "String" -> "ID". Dynamic Component Registration)
â”‚   â”‚   â””â”€â”€ Entity.ts       (Wrapper nháº¹ xung quanh ID)
â”‚   â”œâ”€â”€ systems/
â”‚   â”‚   â””â”€â”€ SystemManager.ts(Quáº£n lÃ½ vÃ²ng láº·p vÃ  thá»© tá»± Æ°u tiÃªn)
â”‚   â””â”€â”€ io/
â”‚       â””â”€â”€ BlueprintLoader.ts (ğŸ”Œ SERIALIZER: Biáº¿n JSON Editor thÃ nh Memory)
â”‚
â”œâ”€â”€ modules/                (ğŸ§© GAME CARTRIDGES - NÆ¡i Logic Game trÃº ngá»¥)
â”‚   â””â”€â”€ cjr/                (ToÃ n bá»™ Code CJR cÅ© dá»i vá» Ä‘Ã¢y)
â”‚       â”œâ”€â”€ definitions/    (Schema: Pigment, Tattoo,Stats)
â”‚       â”œâ”€â”€ systems/        (RingSystem, WaveSpawner, MixingSystem)
â”‚       â”œâ”€â”€ stores/         (TattooStore cÅ© - Ä‘Æ°á»£c bá»c láº¡i)
â”‚       â””â”€â”€ index.ts        (Export CJRModule implementation)
â”‚
â”œâ”€â”€ interfaces/             (ğŸ“œ THE LAW - Há»£p Ä‘á»“ng giao tiáº¿p)
â”‚   â””â”€â”€ IGameModule.ts      (Báº¯t buá»™c má»i Game pháº£i tuÃ¢n thá»§)
â”‚
â”œâ”€â”€ legacy/                 (âš ï¸ QUARANTINE - Khu vá»±c cÃ¡ch ly Code cÅ©)
â”‚   â””â”€â”€ dod/                (ComponentStores.ts trá» vá» MemoryBlock má»›i)
â”‚
â””â”€â”€ index.ts                (Chá»‰ Export Kernel & Interfaces. KHÃ”NG Export CJR)

```

---

## PHáº¦N 2: CÃ”NG NGHá»† LÃ•I (CORE TECHNOLOGY STACK)

### 1. Registry "MÃ¹" (The Blind Registry)

* **Váº¥n Ä‘á» cÅ©:** Engine import cá»©ng `EntityType.JELLY`.
* **Giáº£i phÃ¡p V3.3:** Engine chá»‰ quáº£n lÃ½ ID vÃ  String Key.
```typescript
// Engine khÃ´ng cáº§n biáº¿t Component lÃ m gÃ¬, chá»‰ cáº§n biáº¿t size
const posID = registry.register("Position", { size: 8 }); // x, y
const colorID = registry.register("Pigment", { size: 3 }); // r, g, b

```



### 2. Bá»™ Nhá»› Zero-GC (The Memory Block)

* **CÃ´ng nghá»‡:** `ArrayBuffer` duy nháº¥t cho toÃ n bá»™ Game State.
* **CÆ¡ cháº¿:**
* Dá»¯ liá»‡u táº¥t cáº£ Component cá»§a 1 Entity náº±m liá»n nhau (Archetype) hoáº·c phÃ¢n tÃ¡n (Sparse Set) tÃ¹y chiáº¿n lÆ°á»£c, nhÆ°ng Ä‘á»u náº±m trÃªn `MemoryBlock`.
* **Pointer Caching:** Trong vÃ²ng láº·p `update`, System láº¥y con trá» `Float32Array` ra má»™t láº§n duy nháº¥t, sau Ä‘Ã³ duyá»‡t máº£ng. KhÃ´ng gá»i hÃ m `get()` liÃªn tá»¥c.



### 3. Blueprint Loader (The Bridge)

* **Nhiá»‡m vá»¥:** Äá»c file `level_1.json` (OOP JSON) vÃ  náº¡p vÃ o `MemoryBlock` (Binary).
* **Quy trÃ¬nh:**
1. Parse JSON.
2. DÃ¹ng `registry.lookup("pigment")` Ä‘á»ƒ láº¥y ID.
3. `kernel.createEntity()` -> Nháº­n vá» Index bá»™ nhá»›.
4. Ghi dá»¯ liá»‡u JSON vÃ o Ä‘á»‹a chá»‰ bá»™ nhá»› Ä‘Ã³.



---

## PHáº¦N 3: Há»¢P NHáº¤T CLIENT-SERVER (UNIFIED SIMULATION)

**NguyÃªn táº¯c vÃ ng:** "Má»™t MÃ£ Nguá»“n, Hai NÆ¡i Cháº¡y".

### 1. Server (Authoritative Host)

* Cháº¡y `EidolonEngine` vá»›i `CJRModule`.
* Xá»­ lÃ½ Input chuáº©n.
* Gá»­i Snapshot tráº¡ng thÃ¡i xuá»‘ng Client.

### 2. Client (Shadow Simulation)

* **Bá»:** `OptimizedEngine` (Code riÃªng cá»§a Client cÅ©).
* **THÃŠM:** `EidolonClient` import trá»±c tiáº¿p `packages/engine`.
* **Luá»“ng xá»­ lÃ½:**
1. **Prediction:** Nháº­n Input -> Gá»i `kernel.update()` (Cháº¡y logic giá»‘ng há»‡t Server trÃªn mÃ¡y local).
2. **Correction:** Nháº­n Snapshot Server -> So sÃ¡nh Hash cá»§a `MemoryBlock`. Náº¿u lá»‡ch -> Rollback vÃ  Re-simulate.
3. **Rendering:** `RenderSystem` Ä‘á»c `MemoryBlock` (X, Y, Rotation) -> Cáº­p nháº­t `Pixi.Sprite`.



---

## PHáº¦N 4: Máº NG LÆ¯á»šI KÃ‰P (HYBRID NETWORKING)

Tá»‘i Æ°u hÃ³a bÄƒng thÃ´ng báº±ng cÃ¡ch chia lÃ n Ä‘Æ°á»ng dá»¯ liá»‡u.

| KÃªnh (Lane) | CÃ´ng nghá»‡ | Dá»¯ liá»‡u (Payload) | Táº§n suáº¥t |
| --- | --- | --- | --- |
| **Fast Lane** | **Binary Stream** | `Transform` (x, y, vx, vy), `Rotation` | 20-60Hz |
| **Smart Lane** | **Bitmask Patch** | `Stats` (HP, Mana), `Inventory`, `State` | On-Change |

* **Fast Lane:** Server cáº¯t lÃ¡t (Slice) `MemoryBlock` chá»©a Position vÃ  gá»­i tháº³ng (Zero-Serialization).
* **Smart Lane:** Há»‡ thá»‘ng `DirtyBit` kiá»ƒm tra xem Entity nÃ o thay Ä‘á»•i chá»‰ sá»‘ phá»¥, Ä‘Ã³ng gÃ³i Bitmask vÃ  gá»­i Ä‘i.

---

## PHáº¦N 5: GIAO DIá»†N MODULE (THE CONTRACT)

Äá»ƒ tÃ¡ch Logic khá»i Engine, má»i Game pháº£i cÃ i Ä‘áº·t Interface nÃ y:

```typescript
export interface IGameModule {
    id: string; // "cjr_v1"

    // 1. ÄÄƒng kÃ½ dá»¯ liá»‡u (Schema)
    registerComponents(registry: Registry): void;
    
    // 2. Cung cáº¥p Logic
    getSystems(): ISystem[];

    // 3. Mapping TÃ i nguyÃªn (Fix Ä‘iá»ƒm mÃ¹ Asset)
    getAssetManifest(): Record<string, string>; // "jelly_red" -> "assets/red.png"

    // 4. Mapping Input (Fix Ä‘iá»ƒm mÃ¹ Input)
    getInputMap(): Record<string, string[]>; // "FIRE" -> ["Space", "Tap"]
}

```

---

## PHáº¦N 6: Lá»˜ TRÃŒNH THá»°C THI CHIáº¾N Dá»ŠCH (EXECUTION ROADMAP)

ChÃºng ta Ã¡p dá»¥ng chiáº¿n thuáº­t **"Strangler Fig"** (CÃ¢y Ä‘a bÃ³p cá»•).

### ğŸŸ¢ GIAI ÄOáº N 1: PHáºªU THUáº¬T TÃCH Rá»œI (ISOLATION)

* **Má»¥c tiÃªu:** Engine sáº¡ch bÃ³ng quÃ¢n thÃ¹ (CJR Logic).
* **HÃ nh Ä‘á»™ng:**
1. Táº¡o `IGameModule.ts`.
2. Move toÃ n bá»™ `src/cjr` vÃ o `modules/cjr`.
3. Ngáº¯t `export * from './cjr'` á»Ÿ root.
4. Client vÃ  Server sáº½ bÃ¡o lá»—i -> ÄÃ¢y lÃ  lÃºc ta tháº¥y rÃµ cÃ¡c Ä‘iá»ƒm phá»¥ thuá»™c cáº§n sá»­a.



### ğŸŸ¡ GIAI ÄOáº N 2: XÃ‚Y Dá»°NG Háº T NHÃ‚N (KERNEL GENESIS)

* **Má»¥c tiÃªu:** Engine cÃ³ bá»™ nhá»› vÃ  há»‡ thá»‘ng quáº£n lÃ½ má»›i.
* **HÃ nh Ä‘á»™ng:**
1. Implement `MemoryBlock` (Zero-GC).
2. Implement `Registry` (Dynamic).
3. Viáº¿t `LegacyBridge`: Hack `ComponentStores` cÅ© Ä‘á»ƒ trá» vÃ o `MemoryBlock` má»›i (Giá»¯ game cháº¡y Ä‘Æ°á»£c).



### ğŸŸ  GIAI ÄOáº N 3: Äá»’NG Bá»˜ CLIENT (UNIFICATION)

* **Má»¥c tiÃªu:** Client vÃ  Server dÃ¹ng chung nÃ£o.
* **HÃ nh Ä‘á»™ng:**
1. Client import `packages/engine`.
2. Viáº¿t `EidolonClient` thay tháº¿ `OptimizedEngine`.
3. Káº¿t ná»‘i `RenderSystem` cá»§a PixiJS vÃ o `MemoryBlock`.



### ğŸ”´ GIAI ÄOáº N 4: NETWORKING & TOOLING (OPTIMIZATION)

* **Má»¥c tiÃªu:** Hiá»‡u nÄƒng tá»‘i Ä‘a & Náº¡p liá»‡u tá»± Ä‘á»™ng.
* **HÃ nh Ä‘á»™ng:**
1. Triá»ƒn khai **Hybrid Networking**.
2. HoÃ n thiá»‡n `BlueprintLoader` Ä‘á»ƒ Ä‘á»c JSON tá»« Level Editor.




